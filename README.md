# Fail2Bunny

Automatically sync Bunny CDN edge IP lists to Fail2ban whitelist.

Prevents Bunny edge proxies from getting banned by Fail2ban (which causes 502 errors).

## Overview

Fail2Bunny is a lightweight Python tool that periodically downloads Bunny CDN's edge server IP lists and ensures those networks are whitelisted in Fail2ban. This prevents legitimate traffic from Bunny's edge infrastructure from being incorrectly blocked.

## Features

- ðŸ“¥ Downloads IPv4 and IPv6 edge server lists from Bunny CDN API
- âœ”ï¸ Validates and deduplicates IP addresses/CIDR ranges  
- ðŸ”„ Atomic file updates (safe, no partial writes)
- ðŸŽ¯ Only reloads Fail2ban when changes are detected
- ðŸ›¡ï¸ Supports baseline IPs (localhost, admin IPs)
- ðŸ§ª Dry-run mode for testing
- ðŸ“ Systemd-friendly logging
- ðŸ“¦ **Zero external dependencies** - uses only Python standard library

## Requirements

- Python 3.9+
- Fail2ban installed and configured
- Root/sudo access

## Installation

### Quick Start

```bash
sudo cp fail2bunny.py /usr/local/bin/
sudo chmod +x /usr/local/bin/fail2bunny.py

sudo mkdir -p /etc/fail2bunny
sudo cp config.json.example /etc/fail2bunny/config.json
```

### Systemd Timer (Recommended)

```bash
sudo cp systemd/fail2bunny.service /etc/systemd/system/
sudo cp systemd/fail2bunny.timer /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable --now fail2bunny.timer
```

Monitor the timer:
```bash
sudo systemctl status fail2bunny.timer
sudo systemctl list-timers fail2bunny.timer
```

### Cron Alternative

```bash
sudo crontab -e

# Add this line to run every 6 hours
0 */6 * * * /usr/bin/python3 /usr/local/bin/fail2bunny.py 2>&1 | logger -t fail2bunny
```

## Usage

### Manual Run

```bash
sudo /usr/bin/python3 /usr/local/bin/fail2bunny.py
```

### Dry Run (Preview Changes)

```bash
sudo /usr/bin/python3 /usr/local/bin/fail2bunny.py --dry-run
```

### Verbose Output

```bash
sudo /usr/bin/python3 /usr/local/bin/fail2bunny.py --verbose
```

### View Logs

```bash
sudo journalctl -u fail2bunny.service -f
```

## Configuration

Edit `/etc/fail2bunny/config.json`:

```json
{
    "target_file": "/etc/fail2ban/jail.d/bunny-edges.local",
    "baseline_ignoreip": [
        "127.0.0.1/8",
        "::1",
        "10.0.0.0/8",
        "192.168.1.100"
    ],
    "timeout_seconds": 30,
    "reload_method": "auto"
}
```

### Configuration Options

| Option | Description | Default |
|--------|-------------|---------|
| `target_file` | Path to generated Fail2ban config | `/etc/fail2ban/jail.d/bunny-edges.local` |
| `baseline_ignoreip` | IPs to always include in whitelist | `["127.0.0.1/8", "::1"]` |
| `timeout_seconds` | HTTP timeout in seconds | `30` |
| `reload_method` | How to reload Fail2ban: `auto`, `systemctl`, `service`, `client` | `auto` |

## How It Works

1. **Fetch**: Downloads IPv4 and IPv6 edge server lists from Bunny CDN API
2. **Validate**: Parses and validates all IP addresses and CIDR ranges
3. **Generate**: Creates a Fail2ban jail.d config with `[DEFAULT]` section
4. **Compare**: Checks if new config differs from existing one
5. **Write**: Atomically writes new config (temp file + rename)
6. **Reload**: Reloads Fail2ban only if changes were made

## Generated Config File

The tool generates `/etc/fail2ban/jail.d/bunny-edges.local`:

```ini
# Bunny CDN Edge IP Whitelist for Fail2ban
# Auto-generated by fail2bunny - DO NOT EDIT MANUALLY
#
# IPv4 entries: 595
# IPv6 entries: 345
# Baseline entries: 2

[DEFAULT]
ignoreip = 127.0.0.1/8 ::1 1.2.3.4/32 5.6.7.8/32 ...
```

This extends the `ignoreip` setting for all jails via the `[DEFAULT]` section.

## Verification

Check if Bunny IPs are whitelisted:

```bash
# View all ignoreip rules in Fail2ban config
sudo fail2ban-client -d | grep -i "ignoreip"

# Check specific jail (e.g., sshd)
sudo fail2ban-client get sshd ignoreip

# View the generated config file
sudo cat /etc/fail2ban/jail.d/bunny-edges.local
```

View Fail2ban status:

```bash
sudo fail2ban-client status --all
```

## Troubleshooting

### Fail2ban not reloading

Check if Fail2ban is running:
```bash
sudo systemctl status fail2ban
```

Try manual reload:
```bash
sudo fail2ban-client reload
```

### Check configuration syntax

```bash
sudo fail2ban-client -d
```

### Network connectivity issues

Test connectivity to Bunny CDN:
```bash
curl -I https://bunnycdn.com/api/system/edgeserverlist/
```

## Development

Clone and test locally:

```bash
git clone git@github.com:ronaldvdmeer/Fail2Bunny.git
cd Fail2Bunny

# Test the script
python3 fail2bunny.py --dry-run
```

## License

MIT License

## Author

Ronald van der Meer
